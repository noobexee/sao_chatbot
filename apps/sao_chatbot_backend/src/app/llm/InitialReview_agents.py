import json
import re
from src.app.llm.typhoon import TyphoonLLM

client_wrapper = TyphoonLLM() 
client = client_wrapper.get_model()

class InitialReviewAgents:
    
    def _call_typhoon(self, system_prompt, user_text):
        try:
            full_prompt = f"{system_prompt}\n\nเอกสารที่ต้องตรวจสอบ:\n{user_text}"
            
            # ChatOpenAI.invoke returns an AIMessage object
            response = client.invoke(full_prompt)
            
            content = response.content
            if not content:
                print("⚠️ Typhoon returned empty content.")
                return None

            # Clean Markdown code blocks (```json ... ```) if present
            if "```" in content:
                content = re.sub(r"^```json\s*", "", content, flags=re.MULTILINE)
                content = re.sub(r"^```\s*", "", content, flags=re.MULTILINE)
                content = re.sub(r"```$", "", content, flags=re.MULTILINE)
            
            return json.loads(content.strip())

        except Exception as e:
            print(f"Typhoon Error: {e}")
            # If response variable exists, print it for debugging
            # if 'response' in locals():
            #     print(f"Raw Response: {response}") 
            return None
        
    # --- AGENT 1: Criteria 2 (SAO Authority Check) ---
    def agent_criteria2_sao_authority(self, text):
        system_prompt = """
        คุณคือ 'ผู้เชี่ยวชาญด้านกฎหมายมหาชนและการตรวจสอบภาครัฐ'
        หน้าที่: วิเคราะห์ว่าเรื่องนี้อยู่ในอำนาจหน้าที่ของ **"สำนักงานการตรวจเงินแผ่นดิน (สตง.)"** หรือไม่ โดยต้อง **ฟันธง 100%** ห้ามเข้าข้าง

        **ขอบเขตอำนาจ สตง. (ต้องเข้าข่ายอย่างน้อย 1 ข้อ):**
        1. **การเงิน/การคลัง:** การจัดเก็บรายได้, การรับ-จ่ายเงิน, การเก็บรักษาเงินแผ่นดิน
        2. **การจัดซื้อจัดจ้าง/พัสดุ:** การทำสัญญาจ้าง, ตรวจรับพัสดุ, บริหารพัสดุ
        3. **วินัยทางงบประมาณ:** เบิกจ่ายผิดระเบียบ, เบิกค่าเดินทาง/เบี้ยเลี้ยงเท็จ, ใช้เงินผิดวัตถุประสงค์
        4. **ความคุ้มค่า (Performance Audit):** ใช้จ่ายเงินไม่ประหยัด, จ้างเหมาเกินความจำเป็น, ไม่เกิดผลสัมฤทธิ์
        5. **การใช้ทรัพย์สินของรัฐ:** ใช้รถหลวง, ใช้อุปกรณ์ราชการ, ใช้สถานที่ราชการเพื่อประโยชน์ส่วนตัว
        6. **การก่อสร้างถนน**, สะพาน, อาคารราชการ ที่มีการทุจริตตัวเงิน

        **ข้อยกเว้น (ไม่ใช่ สตง.):**
        - หากเป็น **"ความร่ำรวยผิดปกติ"** (มีทรัพย์สินมากเกินรายได้) -> **ไม่ใช่** (เป็น ป.ป.ช.)
        - หากเป็น **"การละเลยปฏิบัติหน้าที่ระดับสูง/นโยบาย"** (เช่น ครม., คำสั่งศาล) -> **ไม่ใช่** (เป็น ป.ป.ช. หรือ ศาล)
        - หากเป็น **"ความไม่เป็นธรรมของกฎระเบียบ"** (ไม่มีการทุจริตตัวเงิน) -> **ไม่ใช่** (เป็น ผู้ตรวจการแผ่นดิน)
        - หากเป็น **"การเรียกรับผลประโยชน์"** (ไม่มีการทุจริตตัวเงิน)  -> **ไม่ใช่** (เป็น ผู้ตรวจการแผ่นดิน)

        **Few-Shot Examples (กรณีศึกษาจริง):**
        
        [CASE 1: ใช้รถหลวงงานแต่งลูก]
        Input: "นายก อบต.นำรถราชการไปรับส่งชาวบ้านเพื่อไปงานแต่งงานลูกตนเอง"
        Output: "เป็น" (Success)
        Reason: การนำทรัพย์สินของรัฐไปใช้ประโยชน์ส่วนตัวถือเป็นเรื่องวินัยการเงินการคลังและการใช้พัสดุภาครัฐ

        [CASE 2: จ้างเหมาเกินจำเป็น]
        Input: "นายกเทศมนตรี จ้างเหมาบุคคลธรรมดามากเกินความจำเป็น ซ้ำซ้อนกับตำแหน่งงานที่มีอยู่ เพื่อหวังคะแนนเสียง"
        Output: "เป็น" (Success)
        Reason: เป็นเรื่องความคุ้มค่าและการใช้จ่ายเงินงบประมาณที่ไม่เกิดประสิทธิภาพ (Performance Audit)

        [CASE 3: เบิกค่าเดินทางเท็จ]
        Input: "ร้องเรียนการเดินทางไปราชการของสำนักงาน พ. เป็นเท็จ ไม่ได้ไปจริงแต่เบิกเงิน"
        Output: "เป็น" (Success)
        Reason: การเดินทางไปราชการเกี่ยวข้องกับการเบิกจ่ายเงินเบี้ยเลี้ยงและค่าที่พักโดยตรง การฝ่าฝืนระเบียบดังกล่าวจึงส่งผลต่อวินัยการเงินการคลัง

        [CASE 4: ทุจริตก่อสร้างถนน]
        Input: "องค์การบริหารส่วนตำบล A ก่อสร้างถนนเข้าไปในพื้นที่ส่วนบุคคลของผู้ร้องเรียนโดยมิชอบ"
        Output: "เป็น" (Success)
        Reason: เป็นเรื่องการก่อสร้างถนนที่ไม่ถูกต้องหรือไม่ได้คุณภาพอาจจะเกี่ยวกับการทุจริตตัวเงิน ซึ่งอยู่ในอำนาจการตรวจสอบของ สตง.

        [CASE 5: ตรวจสอบโครงการรัฐ]
        Input: "ขอให้ตรวจสอบโครงการตลาดประชารัฐ ของเทศบาล ย. ดำเนินการไม่ชอบด้วยกฎหมาย"
        Output: "เป็น"
        Reason: โครงการของรัฐทุกโครงการมีการใช้จ่ายงบประมาณแผ่นดิน การดำเนินการที่ไม่ชอบด้วยกฎหมายย่อมส่งผลต่อความคุ้มค่าและผลสัมฤทธิ์ของเงินแผ่นดิน

        [CASE 6: ครม. ละเลยคำสั่งศาล]
        Input: "คณะรัฐมนตรีไม่คืนทรัพย์สินของหน่วยงาน ก. ตามคำพิพากษาศาลปกครองสูงสุด"
        Output: "ไม่เป็น" (Fail)
        Reason: เป็นการละเว้นการปฏิบัติหน้าที่ของผู้ดำรงตำแหน่งระดับสูง (ครม.) อยู่ในอำนาจ ป.ป.ช.

        [CASE 7: จัดสรรโควตาไม่เป็นธรรม]
        Input: "หน่วยงานจัดสรรโควตาสลากกาชาติให้สมาคมคนพิการไม่เป็นไปตามระเบียบ"
        Output: "ไม่เป็น" (Fail)
        Reason: เป็นเรื่องการปฏิบัติราชการที่ไม่เป็นธรรมหรือปฏิบัติตามระเบียบไม่ถูกต้อง (ไม่มีเรื่องทุจริตเงินโดยตรง) อยู่ในอำนาจผู้ตรวจการแผ่นดิน

        [CASE 8: ร่ำรวยผิดปกติ]
        Input: "ผอ.โรงเรียน ซื้อรถยนต์หรูหลายคัน ทั้งที่รายได้ประจำไม่เพียงพอ"
        Output: "ไม่เป็น" (Fail)
        Reason: เป็นกรณีร่ำรวยผิดปกติ (Unusual Wealth) ซึ่งเป็นอำนาจเฉพาะของ ป.ป.ช.

        **Output Format (JSON):**
        {
            "status": "success" (ถ้าเป็น) หรือ "fail" (ถ้าไม่เป็น),
            "result": "เป็น" หรือ "ไม่เป็น",
            "reason": "อธิบายเหตุผล (ห้ามอ้างอิงหมายเลขข้อในpromptเด็ดขาด)",
            "evidence": "ข้อความสำคัญจากเอกสาร"
        }
        """
        return self._call_typhoon(system_prompt, text)
  
    # --- AGENT 2: criteria 4 (Detailed Sufficiency Check) ---
    def agent_criteria4_sufficiency(self, text):
        system_prompt = """
        คุณคือ 'ผู้เชี่ยวชาญด้านการตรวจสอบเรื่องร้องเรียนของ สตง.' หน้าที่คือวิเคราะห์องค์ประกอบของเรื่องร้องเรียน
        
        **คำสั่งสำคัญ:** - ต้องดึงข้อมูลออกมาเป็น **Object เดียวเท่านั้น** (ห้ามตอบเป็น List หรือ Array ใน field 'details')
        - หากพบหลายเหตุการณ์ ให้สรุปรวมเป็นข้อความเดียวในแต่ละ field
        
        ให้ดึงข้อมูลดังต่อไปนี้ออกมา (ถ้าไม่พบให้ใส่ null):
        1. **ชื่อหน่วยรับตรวจ (Entity):** ต้องเป็นชื่อหน่วยงานที่ชัดเจน (เช่น "เทศบาลตำบล ก.", "โรงเรียนวัด...", "กรมทางหลวง") 
           - *ห้าม* ตอบคำลอยๆ เช่น "เทศบาลแห่งหนึ่ง", "หน่วยงานราชการ", "อบต." ถ้าไม่ระบุชื่อเฉพาะให้ถือว่า null
        2. **พฤติการณ์ (Behavior):** การกระทำที่ถูกกล่าวหา (เช่น "ทุจริตจัดซื้อ", "นำรถหลวงไปใช้ส่วนตัว")
        3. **เจ้าหน้าที่ผู้ถูกร้อง (Official):** ชื่อ-นามสกุล หรือตำแหน่งที่ระบุตัวตนได้ชัดเจน ของผู้ที่ถูกกล่าวหา
            - *ต้องเป็นชื่อเฉพาะบุคคลเท่านั้น* ต้องมีคำนำหน้า (นาย, นาง, นางสาว, ยศ) ตามด้วยชื่อและนามสกุลจริง
            - *ห้าม* นับนามแฝงหรือชื่อสมมติ เช่น "พลเมืองดี", "ผู้หวังดี", "ชาวบ้าน", "ข้าราชการชั้นผู้น้อย" เป็นชื่อคนเด็ดขาด
        4. **วันเวลา (Date):** ช่วงเวลาที่เกิดเหตุ
        5. **สถานที่ (Location):** สถานที่เกิดเหตุ (จังหวัด, อำเภอ หรือสถานที่เกิดเหตุ)
        
        **เกณฑ์การตัดสิน (Status):**
        - "success": ถ้าพบ (Entity และ Behavior และ Official) ครบถ้วน
        - "fail": ถ้าขาด Entity หรือ Behavior หรือ Officialอย่างใดอย่างหนึ่ง

        ตอบกลับเป็น JSON Structure นี้เท่านั้น:
        {
            "status": "success" หรือ "fail", 
            "title": "ข้อสรุปสั้นๆ (ภาษาไทย)",
            "reason": "เหตุผลประกอบ (ระบุว่าพบหรือขาดอะไร)",
            "details": {
                "entity": "ชื่อหน่วยงานเฉพาะเจาะจง หรือ null",
                "behavior": "พฤติการณ์ หรือ null",
                "official": "ชื่อ/ตำแหน่งผู้ถูกร้อง หรือ null",
                "date": "วันเวลา หรือ null",
                "location": "สถานที่ หรือ null"
            }
        }
        """
        return self._call_typhoon(system_prompt, text)

    # --- AGENT 3: criteria 6 (Specific Person Check) ---
    def agent_criteria6_complainant(self, text):
        system_prompt = """
        คุณคือ 'นายทะเบียน' หน้าที่คือตรวจสอบรายชื่อบุคคลในเอกสาร
        - *ต้องเป็นชื่อเฉพาะบุคคลเท่านั้น* ต้องมีคำนำหน้า (นาย, นาง, นางสาว, ยศ) ตามด้วยชื่อและนามสกุลจริง
        - *ห้าม* นับนามแฝงหรือชื่อสมมติ เช่น "พลเมืองดี", "ผู้หวังดี", "ชาวบ้าน", "ข้าราชการชั้นผู้น้อย" เป็นชื่อคนเด็ดขาด

        ตอบกลับเป็น JSON เท่านั้น:
        {
            "people": [
                { "name": "คำนำหน้า ชื่อ-นามสกุลจริงเท่านั้น", "role": "ผู้ร้องเรียน" หรือ "ผู้ถูกร้องเรียน" หรือ "พยาน" }
            ]
        }
        """
        return self._call_typhoon(system_prompt, text)
    
    # --- AGENT 4: criteria 8 (Other Independent Organizations) --- 
    def agent_criteria8_other_authority(self, text, criteria2_result=None):
        # 1. Prepare Context from Criteria 2 (Smart Context Injection)
        context_instruction = ""
        
        if criteria2_result:
            c2_status = criteria2_result.get("result", "")
            if c2_status == "เป็น":
                # กรณี Criteria 2 บอกว่าเป็น สตง. -> ให้ Criteria 8 เช็คว่ามี Overlap ที่ต้องไปที่อื่นไหม
                context_instruction = """
                **บริบทเพิ่มเติมจาก AI (Criteria 2):** วิเคราะห์แล้วว่าเรื่องนี้ "อยู่ในอำนาจ สตง." (เกี่ยวกับเงิน/พัสดุ)
                **คำสั่งเฉพาะ:** ให้ตรวจสอบซ้ำว่ามีประเด็นทับซ้อนที่รุนแรงจน **ต้อง** ส่งต่อองค์กรอื่นหรือไม่ (เช่น มีการรับสินบนชัดเจน หรือ ร่ำรวยผิดปกติ ซึ่งต้องไป ป.ป.ช.)
                - หากพฤติการณ์หลักยังเป็นเรื่องระเบียบการเงิน/พัสดุ -> ให้ตอบ "ไม่เป็น" (Confirm อำนาจ สตง.)
                - หากพบประเด็นทับซ้อนที่น้ำหนักไปทางองค์กรอื่นมากกว่า -> ให้เปลี่ยนเป็น "เป็น" พร้อมระบุองค์กร
                """
            elif c2_status == "ไม่เป็น":
                # กรณี Criteria 2 บอกว่า ไม่เป็น สตง. -> Criteria 8 ต้องหาเจ้าภาพให้เจอ
                context_instruction = """
                **บริบทเพิ่มเติมจาก AI (Criteria 2):** วิเคราะห์แล้วว่าเรื่องนี้ **"ไม่อยู่ในอำนาจ สตง."**
                **คำสั่งเฉพาะ:** เรื่องนี้มีความเป็นไปได้สูงที่จะเป็นอำนาจขององค์กรอิสระอื่น คุณต้องวิเคราะห์อย่างละเอียดเพื่อระบุว่าควรส่งไปที่ใด (ป.ป.ช., ผู้ตรวจการฯ, กกต., หรือ กสม.)
                """

        system_prompt = f"""
        คุณคือ 'ผู้เชี่ยวชาญกฎหมายมหาชนและเขตอำนาจศาล' หน้าที่ของคุณคือ **คัดกรองเรื่องร้องเรียน** ว่าต้องส่งต่อให้ **"องค์กรอิสระอื่น"** (ที่ไม่ใช่ สตง.) หรือไม่

        {context_instruction}

        **โจทย์สำคัญ:** - เป้าหมายคือการหาว่าเรื่องนี้เป็นอำนาจของ ป.ป.ช., ผู้ตรวจการแผ่นดิน, กกต., หรือ กสม. ใช่หรือไม่?
        - **หากเป็นอำนาจของ "สตง." (สำนักงานการตรวจเงินแผ่นดิน) ให้ถือว่า "ไม่เป็น" (ไม่ใช่องค์กรอื่น)**

        -------------------------------------------------------
        **เกณฑ์การวิเคราะห์ (Decision Hierarchy):**
        ให้พิจารณาตามลำดับความสำคัญดังนี้:

        **1. กลุ่มองค์กรอิสระอื่น (Target = "เป็น"):**
            * **ป.ป.ช. (NACC):** เน้น "ตัวบุคคล" และ "การทุจริตทางอาญา"
                - การรับสินบน (Bribery), เรียกรับผลประโยชน์
                - ร่ำรวยผิดปกติ (Unusual Wealth)
                - เจ้าหน้าที่รัฐปฏิบัติหรือละเว้นการปฏิบัติหน้าที่โดยมิชอบ (ม.157) อย่างชัดเจนโดยไม่มีประเด็นการเงินเข้ามาเกี่ยวข้องเป็นหลัก
            * **ผู้ตรวจการแผ่นดิน (Ombudsman):** - ความไม่เป็นธรรม, ความล่าช้า, ปัญหาจริยธรรม, การละเลยหน้าที่ที่ *ไม่ใช่* การทุจริตตัวเงิน
            * **กกต. (ECT):** ทุจริตเลือกตั้ง, ซื้อสิทธิ์ขายเสียง, คุณสมบัติผู้ดำรงตำแหน่งทางการเมือง
            * **กสม. (NHRC):** ละเมิดสิทธิมนุษยชน, ซ้อมทรมาน, ชุมชนได้รับผลกระทบ

        **2. กลุ่มอำนาจ สตง. (Target = "ไม่เป็น"):**
            * **สตง. (SAO):** เน้น "เม็ดเงินแผ่นดิน" และ "กระบวนการ"
                - การจัดซื้อจัดจ้าง (Procurement) ผิดระเบียบ, ล็อคสเปก (โดยไม่พูดถึงสินบน), ฮั้วประมูล
                - การเบิกจ่ายเงินผิดระเบียบ, ยักยอกเงินหลวง, เอกสารการเงินเท็จ
                - การใช้ทรัพย์สินราชการ (รถหลวง, น้ำมันหลวง)

        -------------------------------------------------------
        **กระบวนการคิดวิเคราะห์ (Chain of Thought):**
        ก่อนตัดสินใจ ให้คุณคิดตาม Step นี้:
        Step 1: พฤติการณ์หลักในข้อร้องเรียนคืออะไร?
        Step 2: มีการกล่าวถึง "สินบน", "รวยผิดปกติ", "เลือกตั้ง" หรือ "ความเดือดร้อนจากการให้บริการ" อย่างชัดเจนหรือไม่? (ถ้ามี -> แนวโน้มเป็นองค์กรอิสระอื่น)
        Step 3: หรือพฤติการณ์เป็นเพียงการใช้งบประมาณผิดระเบียบ, จัดซื้อจัดจ้าง, หรือใช้รถหลวง? (ถ้าใช่ -> เป็น สตง.)
        Step 4: สรุปผล (ถ้าเป็นองค์กรอิสระอื่น ให้ระบุชื่อ หากเป็น สตง. ให้ระบุว่า สตง.)

        -------------------------------------------------------
        **Output Format (JSON เท่านั้น):**
        {{
            "status": "fail" (ถ้า result = เป็น) หรือ "success" (ถ้า result = ไม่เป็น),
            "result": "เป็น" (หากเข้าข่ายองค์กรอื่น) หรือ "ไม่เป็น" (หากเป็นอำนาจ สตง.),
            "organization": "ระบุชื่อองค์กร เช่น ป.ป.ช., ผู้ตรวจการแผ่นดิน, กกต., กสม. หรือ สตง.",
            "reason": "อธิบายสั้นๆ โดยอิง Keywords จากข้อความ",
            "evidence": "คัดลอกข้อความสำคัญจาก input"
        }}
        """
        return self._call_typhoon(system_prompt, text)
    
InitialReview_agents = InitialReviewAgents()