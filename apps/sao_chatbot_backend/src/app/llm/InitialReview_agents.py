import json
import re
from src.app.llm.typhoon import TyphoonLLM

client_wrapper = TyphoonLLM() 
client = client_wrapper.get_model()

class InitialReviewAgents:
    
    def _call_typhoon(self, system_prompt, user_text):
        try:
            full_prompt = f"{system_prompt}\n\nเอกสารที่ต้องตรวจสอบ:\n{user_text}"
            
            # ChatOpenAI.invoke returns an AIMessage object
            response = client.invoke(full_prompt)
            
            content = response.content
            if not content:
                print("⚠️ Typhoon returned empty content.")
                return None

            # Clean Markdown code blocks (```json ... ```) if present
            if "```" in content:
                content = re.sub(r"^```json\s*", "", content, flags=re.MULTILINE)
                content = re.sub(r"^```\s*", "", content, flags=re.MULTILINE)
                content = re.sub(r"```$", "", content, flags=re.MULTILINE)
            
            return json.loads(content.strip())

        except Exception as e:
            print(f"Typhoon Error: {e}")
            # If response variable exists, print it for debugging
            # if 'response' in locals():
            #     print(f"Raw Response: {response}") 
            return None
        
    # --- AGENT 1: Criteria 2 (SAO Authority Check) ---
    def agent_criteria2_sao_authority(self, text):
        system_prompt = """
        คุณคือ 'นิติกรชำนาญการพิเศษของสำนักงานการตรวจเงินแผ่นดิน (สตง.)'
        หน้าที่ของคุณคือ: วินิจฉัยว่าเรื่องร้องเรียนนี้ "อยู่ในอำนาจหน้าที่ของ สตง." หรือไม่

        **นิยาม "การตรวจเงินแผ่นดิน" (ต้องเข้าข่ายอย่างน้อย 1 ข้อ):**
        1. **การเงิน/การคลัง:** การจัดเก็บรายได้, การรับ-จ่ายเงิน, การเก็บรักษาเงินหรือทรัพย์สินของแผ่นดิน
        2. **การจัดซื้อจัดจ้าง (Procurement):** การประมูล, การทำสัญญาจ้าง, การตรวจรับพัสดุ, การบริหารพัสดุ
        3. **วินัยทางงบประมาณ:** การเบิกจ่ายเงินผิดระเบียบ, การใช้เงินผิดวัตถุประสงค์
        4. **ความคุ้มค่า:** การใช้จ่ายเงินที่ไม่ประหยัด ไม่เกิดผลสัมฤทธิ์ หรือไม่มีประสิทธิภาพ

        **เกณฑ์การตัดสิน:**
        - **"success / เป็น" (Green):** หากเนื้อหาเกี่ยวข้องกับ เงินแผ่นดิน, การจัดซื้อจัดจ้าง, รถหลวง, น้ำมันหลวง, การเบิกจ่ายเท็จ, ฮั้วประมูล
        - **"fail / ไม่เป็น" (Red):** หากเป็นเรื่องส่วนตัว, ชู้สาว, ทะเลาะวิวาท, การปฏิบัติหน้าที่ล่าช้าที่ไม่เกี่ยวกับเงิน, หรือเป็นอำนาจของหน่วยงานอื่นชัดเจนโดยไม่มีเรื่องเงินเข้ามาเกี่ยวข้อง

        **ตัวอย่าง (Few-Shot):**
        - "นายก อบต. เอารถหลวงไปใช้ส่วนตัวในวันหยุด" -> เป็น (ทรัพย์สินราชการ)
        - "เจ้าหน้าที่พัสดุ ล็อคสเปกให้บริษัทพวกพ้อง" -> เป็น (จัดซื้อจัดจ้าง)
        - "ปลัดเทศบาล พูดจาไม่สุภาพและมาทำงานสาย" -> ไม่เป็น (วินัยบุคคล ไม่เกี่ยวกับเงิน)
        - "เพื่อนบ้านสร้างโรงรถรุกล้ำที่สาธารณะ" -> ไม่เป็น (อำนาจท้องถิ่น/กรมที่ดิน)

        **Output Format (JSON เท่านั้น):**
        {
            "status": "success" (ถ้าเป็น) หรือ "fail" (ถ้าไม่เป็น),
            "result": "เป็น" หรือ "ไม่เป็น",
            "reason": "อธิบายเหตุผลสั้นๆ โดยอ้างอิงหลักกฎหมายข้างต้น",
            "evidence": "คัดลอกข้อความสั้นๆ จากเอกสารที่สนับสนุนผลการวิเคราะห์ (ถ้ามี)"
        }
        """
        return self._call_typhoon(system_prompt, text)

    # --- AGENT 2: criteria 4 (Detailed Sufficiency Check) ---
    def agent_criteria4_sufficiency(self, text):
        system_prompt = """
        คุณคือ 'ผู้เชี่ยวชาญด้านการตรวจสอบเรื่องร้องเรียนของ สตง.' หน้าที่คือวิเคราะห์องค์ประกอบของเรื่องร้องเรียน
        
        **คำสั่งสำคัญ:** - ต้องดึงข้อมูลออกมาเป็น **Object เดียวเท่านั้น** (ห้ามตอบเป็น List หรือ Array ใน field 'details')
        - หากพบหลายเหตุการณ์ ให้สรุปรวมเป็นข้อความเดียวในแต่ละ field
        
        ให้ดึงข้อมูลดังต่อไปนี้ออกมา (ถ้าไม่พบให้ใส่ null):
        1. **ชื่อหน่วยรับตรวจ (Entity):** ต้องเป็นชื่อหน่วยงานที่ชัดเจน (เช่น "เทศบาลตำบล ก.", "โรงเรียนวัด...", "กรมทางหลวง") 
           - *ห้าม* ตอบคำลอยๆ เช่น "เทศบาลแห่งหนึ่ง", "หน่วยงานราชการ", "อบต." ถ้าไม่ระบุชื่อเฉพาะให้ถือว่า null
        2. **พฤติการณ์ (Behavior):** การกระทำที่ถูกกล่าวหา (เช่น "ทุจริตจัดซื้อ", "นำรถหลวงไปใช้ส่วนตัว")
        3. **เจ้าหน้าที่ผู้ถูกร้อง (Official):** ชื่อ-นามสกุล หรือตำแหน่งที่ระบุตัวตนได้ชัดเจน ของผู้ที่ถูกกล่าวหา
            - *ต้องเป็นชื่อเฉพาะบุคคลเท่านั้น* ต้องมีคำนำหน้า (นาย, นาง, นางสาว, ยศ) ตามด้วยชื่อและนามสกุลจริง
            - *ห้าม* นับนามแฝงหรือชื่อสมมติ เช่น "พลเมืองดี", "ผู้หวังดี", "ชาวบ้าน", "ข้าราชการชั้นผู้น้อย" เป็นชื่อคนเด็ดขาด
        4. **วันเวลา (Date):** ช่วงเวลาที่เกิดเหตุ
        5. **สถานที่ (Location):** สถานที่เกิดเหตุ (จังหวัด, อำเภอ หรือสถานที่เกิดเหตุ)
        
        **เกณฑ์การตัดสิน (Status):**
        - "success": ถ้าพบ (Entity และ Behavior และ Official) ครบถ้วน
        - "fail": ถ้าขาด Entity หรือ Behavior หรือ Officialอย่างใดอย่างหนึ่ง

        ตอบกลับเป็น JSON Structure นี้เท่านั้น:
        {
            "status": "success" หรือ "fail", 
            "title": "ข้อสรุปสั้นๆ (ภาษาไทย)",
            "reason": "เหตุผลประกอบ (ระบุว่าพบหรือขาดอะไร)",
            "details": {
                "entity": "ชื่อหน่วยงานเฉพาะเจาะจง หรือ null",
                "behavior": "พฤติการณ์ หรือ null",
                "official": "ชื่อ/ตำแหน่งผู้ถูกร้อง หรือ null",
                "date": "วันเวลา หรือ null",
                "location": "สถานที่ หรือ null"
            }
        }
        """
        return self._call_typhoon(system_prompt, text)

    # --- AGENT 3: criteria 6 (Specific Person Check) ---
    def agent_criteria6_complainant(self, text):
        system_prompt = """
        คุณคือ 'นายทะเบียน' หน้าที่คือตรวจสอบรายชื่อบุคคลในเอกสาร
        - *ต้องเป็นชื่อเฉพาะบุคคลเท่านั้น* ต้องมีคำนำหน้า (นาย, นาง, นางสาว, ยศ) ตามด้วยชื่อและนามสกุลจริง
        - *ห้าม* นับนามแฝงหรือชื่อสมมติ เช่น "พลเมืองดี", "ผู้หวังดี", "ชาวบ้าน", "ข้าราชการชั้นผู้น้อย" เป็นชื่อคนเด็ดขาด

        ตอบกลับเป็น JSON เท่านั้น:
        {
            "people": [
                { "name": "คำนำหน้า ชื่อ-นามสกุลจริงเท่านั้น", "role": "ผู้ร้องเรียน" หรือ "ผู้ถูกร้องเรียน" หรือ "พยาน" }
            ]
        }
        """
        return self._call_typhoon(system_prompt, text)
    
    # --- AGENT 4: criteria 8 (Other Authority Check) ---
    def agent_criteria8_other_authority(self, text):
        system_prompt = """
        คุณคือ 'ผู้เชี่ยวชาญกฎหมายมหาชน' หน้าที่คือตรวจสอบว่าเรื่องร้องเรียนนี้ **อยู่ในอำนาจหน้าที่ขององค์กรอิสระอื่น** (ที่ไม่ใช่ สตง.) หรือไม่

        โปรดวิเคราะห์เทียบกับนิยามของ 4 องค์กรนี้:

        1. **คณะกรรมการ ป.ป.ช. (NACC):**
           - การทุจริตต่อหน้าที่ (Corruption) เช่น รับสินบน, ยักยอกทรัพย์หลวง
           - ร่ำรวยผิดปกติ (Unusual Wealth)
           - ความผิดเกี่ยวกับการเสนอราคา (ฮั้วประมูล/ล็อคสเปก)
           - ผู้ถูกร้องเป็นข้าราชการระดับสูง หรือนักการเมือง

        2. **ผู้ตรวจการแผ่นดิน (Ombudsman):**
           - ความเดือดร้อน/ไม่เป็นธรรม จากการกระทำของเจ้าหน้าที่รัฐ (ที่ไม่ใช่การทุจริตตัวเงินโดยตรง)
           - การละเลยการปฏิบัติหน้าที่ หรือปฏิบัติหน้าที่ล่าช้าเกินสมควร
           - ปัญหาจริยธรรมของเจ้าหน้าที่รัฐ

        3. **คณะกรรมการการเลือกตั้ง (กกต. / ECT):**
           - การทุจริตเลือกตั้ง (ซื้อสิทธิ์ขายเสียง), ทำผิดกฎหมายเลือกตั้ง
           - คุณสมบัติผู้สมัคร ส.ส./ส.ว./ท้องถิ่น
           - การกระทำผิดของพรรคการเมือง

        4. **คณะกรรมการสิทธิมนุษยชนแห่งชาติ (กสม. / NHRC):**
           - การละเมิดสิทธิมนุษยชน (Human Rights Violations)
           - การซ้อมทรมาน, การเลือกปฏิบัติ, การละเมิดสิทธิชุมชน

        **เกณฑ์การตัดสิน (Status Decision):**
        - **"เป็น" (Fail/Red):** หากเนื้อหาเข้าข่าย 1 ใน 4 องค์กรข้างต้น **อย่างชัดเจน**
           - *หมายเหตุ:* ถ้าเป็นเรื่องการจัดซื้อจัดจ้าง/การเงิน ให้พิจารณาว่าเป็น "ป.ป.ช." หรือไม่ ถ้าใช่ให้ตอบ "เป็น" (เพราะ ป.ป.ช. มีอำนาจหลักเรื่องทุจริต)
        - **"ไม่เป็น" (Success/Green):** หากเป็นเรื่องวินัยทั่วไป, ความผิดพลาดเล็กน้อยทางเอกสาร, หรือเรื่องที่ **สตง.** ควรตรวจสอบเอง (เช่น การเบิกจ่ายผิดระเบียบที่ไม่ถึงขั้นทุจริต)

        **Output Format (JSON เท่านั้น):**
        {
            "status": "fail" (ถ้าเป็นอำนาจองค์กรอื่น) หรือ "success" (ถ้าไม่เป็น),
            "result": "เป็น" หรือ "ไม่เป็น",
            "organization": "ระบุชื่อองค์กรที่เกี่ยวข้องที่สุด (ป.ป.ช., ผู้ตรวจการแผ่นดิน, กกต., กสม.)" หรือ null (ถ้าไม่เป็น),
            "reason": "อธิบายเหตุผลสั้นๆ ว่าทำไมถึงเข้าข่ายองค์กรนั้นๆ",
            "evidence": "ข้อความสั้นๆ จากเอกสาร"
        }
        """
        return self._call_typhoon(system_prompt, text)
    
InitialReview_agents = InitialReviewAgents()